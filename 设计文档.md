# 双人数独对战游戏设计文档

## 1. 项目概述

本项目是一个基于Web的双人数独对战游戏，支持实时联机对战、房间系统、掉线重连等功能。

## 2. 技术栈

### 2.1 后端
- **语言**: Python 3.9+
- **Web框架**: FastAPI（异步优先；若使用 Flask 需统一到对应 WebSocket 方案）
- **WebSocket**: python-socketio（Socket.IO 协议）或 FastAPI 原生 WebSocket（二选一，避免混用）
- **数独生成**: 自定义 Python 算法

### 2.2 前端
- **框架**: Vue 3 或 React（二选一；本文示例默认 Vue 3）
- **WebSocket客户端**: Socket.IO Client（若后端走原生 WebSocket，则改用原生 WS 客户端）
- **UI组件**: Element Plus（Vue）或 Ant Design（React），与框架配套
- **状态管理**: Pinia（Vue）或 Redux（React）

## 3. 系统架构

```
┌─────────────┐         WebSocket/HTTP        ┌─────────────┐
│   前端界面   │ ◄──────────────────────────► │  后端服务器  │
│  (浏览器)   │                               │   (Python)  │
└─────────────┘                               └─────────────┘
      │                                              │
      │                                              │
      ▼                                              ▼
  游戏状态管理                                  房间管理系统
  计时器管理                                    数独生成器
  WebSocket连接                                 玩家状态追踪
```

## 4. 核心功能模块

### 4.1 数独生成模块

**难度等级**:
- 简单 (Easy): 40-45个预填数字
- 中等 (Medium): 35-40个预填数字
- 困难 (Hard): 30-35个预填数字
- 特难 (Very Hard): 25-30个预填数字
- 极难 (Extreme): 20-25个预填数字

**生成算法**:
1. 生成完整的9x9数独解
2. 根据难度随机挖空
3. 确保唯一解
4. 返回JSON格式数据

**数据格式**:
**对外返回(客户端)**:
```json
{
  "puzzle": [[5,3,0,...], [6,0,0,...], ...],
  "difficulty": "medium",
  "puzzle_id": "uuid"
}
```
**服务器内部**:
```json
{
  "puzzle": [[5,3,0,...], [6,0,0,...], ...],
  "solution": [[5,3,4,...], [6,7,2,...], ...],
  "difficulty": "medium",
  "puzzle_id": "uuid"
}
```
> `solution` 仅保存在服务器端用于校验，不能下发到客户端，避免作弊。

### 4.2 房间系统

**房间状态**:
- `waiting`: 等待玩家加入
- `ready`: 双方准备就绪
- `playing`: 游戏进行中
- `paused`: 游戏暂停(掉线)
- `finished`: 游戏结束

**房间数据结构(服务器侧)**:
```python
{
  "room_id": "6位房间号",
  "host": "玩家1信息",
  "guest": "玩家2信息",
  "difficulty": "难度",
  "puzzle_id": "uuid",
  "puzzle": "数独题目",
  "solution": "数独解答(仅服务器保存)",
  "status": "房间状态",
  "created_at": "创建时间",
  "started_at": "开始时间"
}
```

### 4.3 玩家状态管理

**玩家数据**:
```python
{
  "player_id": "唯一标识",
  "nickname": "昵称",
  "player_token": "重连凭证",
  "connection_status": "online/offline",
  "timer": 0,  # 服务器权威计时(秒)
  "errors": 0,  # 错误次数(最多3次)
  "progress": [[...], [...], ...],  # 当前填写进度
  "completed": false
}
```

### 4.4 掉线处理机制

**掉线检测**:
- WebSocket心跳检测(每5秒)
- 超时时间: 15秒

**掉线处理流程**:
1. 检测到掉线 → 暂停双方计时器
2. 通知对方玩家"对手已掉线"
3. 保存当前游戏状态
4. 等待重连(超时时间: 5分钟)

**重连流程**:
1. 玩家重新连接 → 使用 `player_token` 验证身份
2. 恢复游戏状态和进度
3. 恢复计时器
4. 通知对方"对手已重连"

**重开局**:
- 超过5分钟未重连 → 提示对方选择"等待"或"重开局"
- 选择重开局 → 生成新题目，重置状态

## 5. API设计

### 5.1 HTTP接口

| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/room/create` | POST | 创建房间 |
| `/api/room/join` | POST | 加入房间 |
| `/api/room/info` | GET | 获取房间信息 |
| `/api/puzzle/generate` | POST | 生成数独题目(仅返回 puzzle，不返回 solution) |

> 创建/加入房间的响应需包含 `player_token`，用于重连身份校验；房间信息不返回 `solution`。

**请求示例**:
```http
POST /api/puzzle/generate
Content-Type: application/json

{
  "difficulty": "medium"
}

POST /api/room/create
Content-Type: application/json

{
  "player_name": "玩家1",
  "difficulty": "hard"
}

POST /api/room/join
Content-Type: application/json

{
  "room_id": "123456",
  "player_name": "玩家2"
}
```

### 5.2 WebSocket事件

**客户端 → 服务器**:
- `join_room`: 加入房间
- `ready`: 准备就绪
- `fill_cell`: 填写单元格
- `heartbeat`: 心跳
- `reconnect`: 重连

**服务器 → 客户端**:
- `room_created`: 房间创建成功
- `player_joined`: 玩家加入
- `game_start`: 游戏开始
- `cell_result`: 本人填写结果(正确/错误/错误次数)
- `opponent_progress`: 对手进度更新(不包含数字值)
- `player_disconnected`: 玩家掉线
- `player_reconnected`: 玩家重连
- `game_over`: 游戏结束
- `state_sync`: 状态同步(用于重连/断线恢复)
- `timer_update`: 计时器更新(可选，用于校准)

## 6. 前端页面设计

### 6.1 页面结构

1. **首页** (`/`)
   - 创建房间按钮
   - 加入房间输入框
   - 难度选择

2. **等待页** (`/room/:id/waiting`)
   - 显示房间号
   - 等待对方加入提示
   - 准备按钮

3. **游戏页** (`/room/:id/game`)
   - 数独棋盘(9x9)
   - 数字输入面板(1-9)
   - 计时器(双方独立显示，服务器校准)
   - 错误次数显示
   - 对手进度提示
   - 退出/投降按钮

4. **结果页** (`/room/:id/result`)
   - 胜负结果
   - 用时统计
   - 再来一局按钮

### 6.2 游戏界面元素

**数独棋盘**:
- 9x9网格
- 预填数字(灰色，不可修改)
- 玩家填写数字(蓝色，可修改)
- 错误数字(红色标记)
- 对手进度提示(仅显示对手填格数量或进度，不显示具体数字)

**状态栏**:
```
┌────────────────────────────────────┐
│ 你: 05:23  错误: 1/3               │
│ 对手: 04:56  错误: 0/3             │
└────────────────────────────────────┘
```

## 7. 游戏流程

### 7.1 完整流程

```
1. 玩家A创建房间 → 选择难度 → 获得房间号
2. 玩家B输入房间号 → 加入房间
3. 双方点击"准备" → 服务器生成数独题目
4. 游戏开始 → 服务器开始计时(客户端独立显示并定期校准)
5. 玩家填写数字 → 服务端实时验证
   - 正确: 继续
   - 错误: 错误次数+1，标红提示
   - 错误3次: 游戏失败
6. 完成所有格子 → 游戏结束
7. 显示结果 → 选择再来一局或退出
```

### 7.2 掉线场景

**场景1: 游戏中掉线**
```
玩家A掉线 → 暂停计时 → 显示"对手掉线"
→ 玩家A重连 → 恢复游戏 → 继续计时
```

**场景2: 超时未重连**
```
玩家A掉线 → 等待5分钟 → 超时
→ 提示玩家B: "对手已离开，是否重开局？"
→ 选择"是": 生成新题目
→ 选择"否": 返回首页
```

## 8. 数据存储

### 8.1 内存存储(Redis/字典)

- 房间信息
- 玩家在线状态
- 游戏进度
- 题目解答(仅服务器保存)

### 8.2 持久化存储(可选)

- 游戏历史记录
- 玩家统计数据

## 9. 安全性考虑

1. **输入验证**: 验证数独填写的合法性
2. **房间号生成**: 随机6位数字，避免碰撞
3. **防作弊**: 服务器端验证所有填写操作
4. **连接认证**: WebSocket连接时验证玩家身份

## 10. 性能优化

1. **数独生成缓存**: 预生成不同难度的题目池
2. **WebSocket心跳**: 合理设置心跳间隔，避免过频
3. **前端渲染优化**: 虚拟DOM，局部更新
4. **房间清理**: 定时清理过期房间

## 11. 开发计划

### Phase 1: 核心功能
- 数独生成算法
- 基础房间系统
- 单人游戏模式

### Phase 2: 联机对战
- WebSocket通信
- 双人对战逻辑
- 实时同步

### Phase 3: 高级功能
- 掉线重连
- 计时器管理
- 错误处理

### Phase 4: 优化完善
- UI/UX优化
- 性能优化
- 测试与调试

## 12. 目录结构(计划)

```
ShuDuWeb/
├── backend/
│   ├── app.py              # 主应用入口
│   ├── sudoku_generator.py # 数独生成算法
│   ├── room_manager.py     # 房间管理
│   ├── websocket_handler.py# WebSocket处理
│   └── requirements.txt    # Python依赖
├── frontend/
│   ├── src/
│   │   ├── components/     # Vue/React组件
│   │   ├── views/          # 页面
│   │   ├── store/          # 状态管理
│   │   └── utils/          # 工具函数
│   ├── public/
│   └── package.json
└── 设计文档.md
```
